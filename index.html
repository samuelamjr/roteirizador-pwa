<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Roteirizador</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0b5ed7" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto; }
    #app { display: grid; grid-template-columns: 340px 1fr; height: 100%; }
    #sidebar { padding: 10px; border-right: 1px solid #e5e7eb; overflow:auto; }
    #map { width: 100%; height: 100%; }
    .panel { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 10px; margin-bottom: 10px; box-shadow: 0 1px 2px rgba(0,0,0,.05); }
    .panel h3 { margin: 0 0 8px; font-size: 16px; }
    .row { display: flex; gap: 6px; align-items: center; margin-bottom: 8px; }
    input[type="text"], select { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 8px; }
    .btn { background: #0b5ed7; color:#fff; border:0; padding:8px 10px; border-radius:10px; cursor:pointer; }
    .btn.secondary { background:#374151; }
    .muted { color:#6b7280; font-size:12px; }
    .legend { display:flex; flex-wrap: wrap; gap:6px; }
    .legend span { font-size:12px; padding:4px 6px; border-radius:6px; background:#eef2ff; }
    @media (max-width: 900px) {
      #app { grid-template-columns: 1fr; }
      #sidebar { border-right: 0; border-bottom: 1px solid #e5e7eb; }
      #map { height: calc(100vh - 360px); }
    }
  </style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <div class="panel">
      <h3>Planejar rota</h3>
      <div class="row"><input id="start" type="text" placeholder="Origem (ex.: SÃ£o Paulo, SP)" /></div>
      <div class="row"><input id="end" type="text" placeholder="Destino (ex.: Campos do JordÃ£o, SP)" /></div>
      <div class="row">
        <select id="profile">
          <option value="driving">Carro / Moto</option>
          <option value="foot">A pÃ©</option>
          <option value="cycling">Bicicleta</option>
        </select>
        <input id="radius" type="number" min="100" step="100" value="1000" title="Raio (m)" />
      </div>
      <div class="row">
        <button id="goBtn" class="btn">TraÃ§ar rota</button>
        <button id="clearBtn" class="btn secondary">Limpar</button>
      </div>
      <div class="muted">ğŸ’¡ Dica: toque/segure a <b>linha azul</b> e arraste para criar um desvio (waypoint) por regiÃµes mais turÃ­sticas.</div>
      <div id="summary" class="muted" style="margin-top:6px;">â€”</div>
    </div>

    <div class="panel">
      <h3>POIs ao longo do trajeto</h3>
      <div class="legend">
        <span>ğŸ¨ HotÃ©is</span><span>ğŸ½ï¸ Restaurantes</span><span>â˜• CafÃ©s</span><span>ğŸº Bares</span>
        <span>â›½ Postos</span><span>ğŸ¥ Hospitais</span><span>ğŸ’Š FarmÃ¡cias</span><span>ğŸ‘€ Mirantes</span><span>ğŸ¯ AtraÃ§Ãµes</span>
      </div>
      <div style="margin-top:8px">
        <label><input type="checkbox" class="cat" value="hotel" checked /> HotÃ©is/pousadas/hostel</label><br />
        <label><input type="checkbox" class="cat" value="restaurant" checked /> Restaurantes</label><br />
        <label><input type="checkbox" class="cat" value="cafe" /> CafÃ©s</label><br />
        <label><input type="checkbox" class="cat" value="bar" /> Bares</label><br />
        <label><input type="checkbox" class="cat" value="fuel" checked /> Postos</label><br />
        <label><input type="checkbox" class="cat" value="hospital" checked /> Hospitais</label><br />
        <label><input type="checkbox" class="cat" value="pharmacy" /> FarmÃ¡cias</label><br />
        <label><input type="checkbox" class="cat" value="viewpoint" /> Mirantes</label><br />
        <label><input type="checkbox" class="cat" value="attraction" /> AtraÃ§Ãµes</label>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="poisBtn" class="btn" disabled>Buscar POIs (manual)</button>
        <span class="muted">POIs atualizam <b>automaticamente</b> quando a rota muda.</span>
      </div>
      <div id="poiCount" class="muted"></div>
    </div>

    <div class="panel">
      <h3>Instalar</h3>
      <div class="muted">No celular: â€œAdicionar Ã  tela inicialâ€.</div>
    </div>
  </div>

  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

<script>
// ====== MAPA ======
const map = L.map('map').setView([-23.55,-46.63],7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(map);

let routeControl;        // controle do Leaflet Routing Machine
let autoFetchTimer=null; // debounce para atualizar POIs
const poiLayer = L.layerGroup().addTo(map);

// ====== Ãcone de POIs ======
const iconFor = (cat) => L.divIcon({
  className: 'poi',
  html: `<div style="background:#111827;color:#fff;border-radius:10px;padding:2px 6px;font-size:12px;">${{
    hotel:'ğŸ¨', guest_house:'ğŸ¨', hostel:'ğŸ¨', motel:'ğŸ¨',
    restaurant:'ğŸ½ï¸', cafe:'â˜•', bar:'ğŸº',
    fuel:'â›½', hospital:'ğŸ¥', pharmacy:'ğŸ’Š',
    viewpoint:'ğŸ‘€', attraction:'ğŸ¯'
  }[cat]||'ğŸ“'}</div>`
});

// ====== GeocodificaÃ§Ã£o (Nominatim) ======
async function geocode(q){
  const u=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`;
  const r=await fetch(u,{headers:{'Accept-Language':'pt-BR'}});
  const j=await r.json(); if(!j[0]) throw new Error('EndereÃ§o nÃ£o encontrado: '+q);
  return L.latLng(parseFloat(j[0].lat),parseFloat(j[0].lon));
}

// ====== CRIAR/CONFIGURAR O CONTROLE DE ROTA ======
function buildRouter(profile){
  if (!routeControl) {
    routeControl = L.Routing.control({
      waypoints: [],
      // ğŸ”‘ habilita arrastar a linha e criar pontos intermediÃ¡rios
      routeWhileDragging: true,
      draggableWaypoints: true,
      addWaypoints: true,

      show: false,
      collapsible: true,
      lineOptions: { addWaypoints: true },

      plan: L.Routing.plan([], {
        createMarker: (i, wp) => L.marker(wp.latLng)
      }),

      router: L.Routing.osrmv1({
        serviceUrl: 'https://router.project-osrm.org/route/v1',
        profile: profile || 'driving'
      })
    }).addTo(map);

    const refresh = () => {
      if (autoFetchTimer) clearTimeout(autoFetchTimer);
      autoFetchTimer = setTimeout(fetchPOIs, 600);
    };

    routeControl.on('routesfound', (e) => {
      const r = e.routes[0]; if (!r) return;
      const km  = (r.summary.totalDistance/1000).toFixed(1);
      const min = Math.round(r.summary.totalTime/60);
      document.getElementById('summary').textContent =
        `DistÃ¢ncia: ${km} km Â· Tempo: ${min} min`;
      document.getElementById('poisBtn').disabled = false;
      refresh();
    });

    routeControl.on('waypointschanged', refresh);
    routeControl.on('routeselected',   refresh);
  } else {
    // apenas troca o perfil do roteador (nÃ£o recria o controle!)
    routeControl.getRouter().options.profile = profile || 'driving';
  }
}

// iniciar com perfil driving
buildRouter('driving');

// ====== BOTÃ•ES ======
document.getElementById('goBtn').addEventListener('click', async()=>{
  const s=document.getElementById('start').value.trim();
  const e=document.getElementById('end').value.trim();
  const p=document.getElementById('profile').value;
  if(!s||!e){alert('Informe origem e destino.');return;}

  buildRouter(p); // garante o controle ativo e perfil correto

  try{
    const [a,b]=await Promise.all([geocode(s),geocode(e)]);
    routeControl.setWaypoints([a,b]); // sÃ³ define os pontos (sem recriar controle)
    poiLayer.clearLayers();
    document.getElementById('poiCount').textContent='';
  }catch(err){ alert(err.message); }
});

document.getElementById('clearBtn').addEventListener('click',()=>{
  if (routeControl) routeControl.setWaypoints([]);
  poiLayer.clearLayers();
  document.getElementById('summary').textContent='â€”';
  document.getElementById('poiCount').textContent='';
  document.getElementById('poisBtn').disabled=true;
});

document.getElementById('profile').addEventListener('change', (e) => {
  buildRouter(e.target.value); // sem recriar do zero
});

// ====== POIs via Overpass (dentro do bbox da rota, filtrados por distÃ¢ncia) ======
async function fetchPOIs(){
  // recupera a geometria da rota atual (se houver)
  const routes = routeControl && routeControl._routes;
  if (!routes || !routes[0] || !routes[0].coordinates) return;

  // linha da rota (array de LatLng)
  const coords = routes[0].coordinates;
  const turfLine = turf.lineString(coords.map(p=>[p.lng,p.lat]));

  const radiusM=parseInt(document.getElementById('radius').value||'1000',10);
  const selected=Array.from(document.querySelectorAll('.cat:checked')).map(c=>c.value);
  if(selected.length===0){document.getElementById('poiCount').textContent='Selecione categorias.';return;}

  // bounding box da rota
  const l = L.polyline(coords);
  const b = l.getBounds();
  const bbox=[b.getSouth(),b.getWest(),b.getNorth(),b.getEast()];

  const parts=[]; const push=(q)=>parts.push(q+`(${bbox.join(',')});`);
  if(selected.includes('hotel')){push('node[tourism=hotel]');push('node[tourism=guest_house]');push('node[tourism=hostel]');push('node[tourism=motel]');}
  if(selected.includes('restaurant')) push('node[amenity=restaurant]');
  if(selected.includes('cafe'))       push('node[amenity=cafe]');
  if(selected.includes('bar'))        push('node[amenity=bar]');
  if(selected.includes('fuel'))       push('node[amenity=fuel]');
  if(selected.includes('hospital'))   push('node[amenity=hospital]');
  if(selected.includes('pharmacy'))   push('node[amenity=pharmacy]');
  if(selected.includes('viewpoint'))  push('node[tourism=viewpoint]');
  if(selected.includes('attraction')) push('node[tourism=attraction]');

  const url=`https://overpass-api.de/api/interpreter?data=${encodeURIComponent('[out:json][timeout:25];('+parts.join('')+');out center;')}`;

  poiLayer.clearLayers();
  document.getElementById('poiCount').textContent='Atualizando POIsâ€¦';

  try{
    const r=await fetch(url); const j=await r.json();
    let c=0;
    for(const el of j.elements||[]){
      const lat=el.lat||(el.center&&el.center.lat);
      const lon=el.lon||(el.center&&el.center.lon);
      if(lat==null||lon==null) continue;
      const d=turf.pointToLineDistance(turf.point([lon,lat]), turfLine, {units:'meters'});
      if(d<=radiusM){
        const tags=el.tags||{};
        const cat=tags.tourism||tags.amenity||'poi';
        const name=tags.name||'(sem nome)';
        const phone=tags['phone']||tags['contact:phone']||tags['phone:mobile']||'';
        const website=tags['website']||tags['contact:website']||'';
        const info=[]; if(phone) info.push('Fone: '+phone); if(website) info.push(`<a href="${website}" target="_blank">Site</a>`);
        L.marker([lat,lon],{icon:iconFor(cat)})
          .bindPopup(`<b>${name}</b><br/><span class="muted">${cat}</span><br/>${info.join('<br/>')}`)
          .addTo(poiLayer);
        c++;
      }
    }
    document.getElementById('poiCount').textContent=`${c} ponto(s) dentro de ${radiusM} m do trajeto.`;
  }catch(e){ document.getElementById('poiCount').textContent='Erro ao buscar POIs.'; }
}
document.getElementById('poisBtn').addEventListener('click', fetchPOIs);

// ====== Registrar Service Worker do PWA ======
if("serviceWorker" in navigator){
  window.addEventListener("load",()=>navigator.serviceWorker.register("./sw.js"));
}
</script>
</body>
</html>
