<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Roteirizador</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0b5ed7" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto; }
    #app { display: grid; grid-template-columns: 340px 1fr; height: 100%; }
    #sidebar { padding: 10px; border-right: 1px solid #e5e7eb; overflow:auto; }
    #map { width: 100%; height: 100%; }
    .panel { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 10px; margin-bottom: 10px; box-shadow: 0 1px 2px rgba(0,0,0,.05); }
    .panel h3 { margin: 0 0 8px; font-size: 16px; }
    .row { display: flex; gap: 6px; align-items: center; margin-bottom: 8px; }
    input[type="text"], select { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 8px; }
    .btn { background: #0b5ed7; color:#fff; border:0; padding:8px 10px; border-radius:10px; cursor:pointer; }
    .btn.secondary { background:#374151; }
    .muted { color:#6b7280; font-size:12px; }
    .legend { display:flex; flex-wrap: wrap; gap:6px; }
    .legend span { font-size:12px; padding:4px 6px; border-radius:6px; background:#eef2ff; }
    @media (max-width: 900px) {
      #app { grid-template-columns: 1fr; }
      #sidebar { border-right: 0; border-bottom: 1px solid #e5e7eb; }
      #map { height: calc(100vh - 420px); }
    }
  </style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <div class="panel">
      <h3>Planejar rota</h3>
      <div class="row"><input id="start" type="text" placeholder="Origem (ex.: São Paulo, SP)" /></div>
      <div class="row"><input id="end" type="text" placeholder="Destino (ex.: Campos do Jordão, SP)" /></div>
      <div class="row">
        <select id="profile">
          <option value="driving">Carro / Moto</option>
          <option value="foot">A pé</option>
          <option value="cycling">Bicicleta</option>
        </select>
        <input id="radius" type="number" min="100" step="100" value="1000" title="Raio (m)" />
      </div>
      <div class="row">
        <button id="goBtn" class="btn">Traçar rota</button>
        <button id="clearBtn" class="btn secondary">Limpar</button>
      </div>
      <!-- Botões novos para celular -->
      <div class="row">
        <button id="divertBtn" class="btn" title="Adicionar desvio tocando no mapa">Desviar (tocar no mapa)</button>
        <button id="undoDivertBtn" class="btn secondary" title="Remover último desvio">Remover último</button>
      </div>
      <div class="muted">💡 Dica: você pode arrastar a <b>linha azul</b> no PC, ou usar o botão “Desviar” e tocar no mapa no celular.</div>
      <div id="summary" class="muted" style="margin-top:6px;">—</div>
    </div>

    <div class="panel">
      <h3>POIs ao longo do trajeto</h3>
      <div class="legend">
        <span>🏨 Hotéis</span><span>🍽️ Restaurantes</span><span>☕ Cafés</span><span>🍺 Bares</span>
        <span>⛽ Postos</span><span>🏥 Hospitais</span><span>💊 Farmácias</span><span>👀 Mirantes</span><span>🎯 Atrações</span>
      </div>
      <div style="margin-top:8px">
        <label><input type="checkbox" class="cat" value="hotel" checked /> Hotéis/pousadas/hostel</label><br />
        <label><input type="checkbox" class="cat" value="restaurant" checked /> Restaurantes</label><br />
        <label><input type="checkbox" class="cat" value="cafe" /> Cafés</label><br />
        <label><input type="checkbox" class="cat" value="bar" /> Bares</label><br />
        <label><input type="checkbox" class="cat" value="fuel" checked /> Postos</label><br />
        <label><input type="checkbox" class="cat" value="hospital" checked /> Hospitais</label><br />
        <label><input type="checkbox" class="cat" value="pharmacy" /> Farmácias</label><br />
        <label><input type="checkbox" class="cat" value="viewpoint" /> Mirantes</label><br />
        <label><input type="checkbox" class="cat" value="attraction" /> Atrações</label>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="poisBtn" class="btn" disabled>Buscar POIs (manual)</button>
        <span class="muted">POIs atualizam <b>automaticamente</b> quando a rota muda.</span>
      </div>
      <div id="poiCount" class="muted"></div>
    </div>

    <div class="panel">
      <h3>Instalar</h3>
      <div class="muted">No celular: “Adicionar à tela inicial”.</div>
    </div>
  </div>

  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

<script>
// ==== Mapa básico ====
const map = L.map('map').setView([-23.55,-46.63],7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(map);

let routeControl;
let autoFetchTimer=null;
const poiLayer = L.layerGroup().addTo(map);

// ==== Ícones de POIs ====
const iconFor = (cat) => L.divIcon({ className: 'poi', html: `<div style="background:#111827;color:#fff;border-radius:10px;padding:2px 6px;font-size:12px;">${{hotel:'🏨',guest_house:'🏨',hostel:'🏨',motel:'🏨',restaurant:'🍽️',cafe:'☕',bar:'🍺',fuel:'⛽',hospital:'🏥',pharmacy:'💊',viewpoint:'👀',attraction:'🎯'}[cat]||'📍'}</div>` });

// ==== Geocodificação ====
async function geocode(q){
  const u=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`;
  const r=await fetch(u,{headers:{'Accept-Language':'pt-BR'}});
  const j=await r.json(); if(!j[0]) throw new Error('Endereço não encontrado: '+q);
  return L.latLng(parseFloat(j[0].lat),parseFloat(j[0].lon));
}

// ==== Controle de rota ====
function buildRouter(profile){
  if (!routeControl) {
    routeControl = L.Routing.control({
      waypoints: [],
      routeWhileDragging: true,
      draggableWaypoints: true,
      addWaypoints: true,
      show: false, collapsible: true,
      lineOptions: { addWaypoints: true },
      plan: L.Routing.plan([], { createMarker: (i, wp) => L.marker(wp.latLng) }),
      router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1', profile: profile||'driving' })
    }).addTo(map);

    const refresh=()=>{ if(autoFetchTimer) clearTimeout(autoFetchTimer); autoFetchTimer=setTimeout(fetchPOIs,600); };
    routeControl.on('routesfound',(e)=>{const r=e.routes[0];if(!r)return;const km=(r.summary.totalDistance/1000).toFixed(1);const min=Math.round(r.summary.totalTime/60);document.getElementById('summary').textContent=`Distância: ${km} km · Tempo: ${min} min`;document.getElementById('poisBtn').disabled=false;refresh();});
    routeControl.on('waypointschanged',refresh);
    routeControl.on('routeselected',refresh);
  } else {
    routeControl.getRouter().options.profile=profile||'driving';
  }
}
buildRouter('driving');

// ==== Botões principais ====
document.getElementById('goBtn').addEventListener('click',async()=>{
  const s=document.getElementById('start').value.trim();
  const e=document.getElementById('end').value.trim();
  const p=document.getElementById('profile').value;
  if(!s||!e){alert('Informe origem e destino.');return;}
  buildRouter(p);
  try{const[a,b]=await Promise.all([geocode(s),geocode(e)]);routeControl.setWaypoints([a,b]);poiLayer.clearLayers();document.getElementById('poiCount').textContent='';}catch(err){alert(err.message);}
});
document.getElementById('clearBtn').addEventListener('click',()=>{if(routeControl)routeControl.setWaypoints([]);poiLayer.clearLayers();document.getElementById('summary').textContent='—';document.getElementById('poiCount').textContent='';document.getElementById('poisBtn').disabled=true;});
document.getElementById('profile').addEventListener('change',(e)=>{buildRouter(e.target.value);});

// ==== Novo recurso: modo desvio para celular ====
let divertMode=false;
document.getElementById('divertBtn').addEventListener('click',()=>{divertMode=!divertMode;document.getElementById('divertBtn').style.background=divertMode?'#16a34a':'#0b5ed7';});
document.getElementById('undoDivertBtn').addEventListener('click',()=>{if(!routeControl)return;const wps=routeControl.getWaypoints();if(wps.length>2){routeControl.spliceWaypoints(wps.length-2,1);}});
map.on('click',(e)=>{if(!divertMode||!routeControl)return;const wps=routeControl.getWaypoints().filter(w=>!!w.latLng);if(wps.length<2){divertMode=false;document.getElementById('divertBtn').style.background='#0b5ed7';return;}routeControl.spliceWaypoints(wps.length-1,0,e.latlng);divertMode=false;document.getElementById('divertBtn').style.background='#0b5ed7';});

// ==== Buscar POIs (Overpass) ====
async function fetchPOIs(){ /* ... mesmo código que você já tinha para POIs ... */ }
document.getElementById('poisBtn').addEventListener('click', fetchPOIs);

// ==== Service Worker ====
if("serviceWorker" in navigator){window.addEventListener("load",()=>navigator.serviceWorker.register("./sw.js"));}
</script>
</body>
</html>
